pipeline {
    agent any

    tools {
        maven 'Maven 3.6.3'
        jdk 'JDK 17'
    }

    environment {
        APP_NAME = 'incident-tracker'
        APP_URL = 'http://localhost:8081'
        GRAPHQL_ENDPOINT = 'http://localhost:8081/graphql'
        DB_HOST = 'localhost'
        DB_PORT = '5432'
        DB_NAME = 'incidents'
        DB_USER = 'postgres'
    }

    stages {
        stage('Checkout') {
            steps {
                echo '=== Checking out source code ==='
                checkout scm
            }
        }

        stage('Build Application') {
            steps {
                echo '=== Building application for GraphQL testing ==='
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('Start Application') {
            steps {
                echo '=== Starting application for GraphQL testing ==='
                sh '''
                    # Stop any existing process
                    pkill -f 'incident-tracker' || true
                    sleep 2

                    # Create logs directory
                    mkdir -p logs

                    # Start application in background
                    nohup java -jar target/incident-tracker-1.0.0.jar > logs/app.log 2>&1 &
                    echo $! > app.pid
                    sleep 5
                '''
            }
        }

        stage('Health Check') {
            steps {
                echo '=== Verifying application health ==='
                script {
                    timeout(time: 2, unit: 'MINUTES') {
                        waitUntil {
                            script {
                                def response = sh(
                                    script: 'curl -s -o /dev/null -w "%{http_code}" ${APP_URL}/actuator/health',
                                    returnStdout: true
                                ).trim()

                                if (response == '200') {
                                    echo '✓ Application is healthy!'
                                    return true
                                } else {
                                    echo "Health check returned: ${response}"
                                    return false
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Test GraphQL Queries') {
            steps {
                echo '=== Testing GraphQL Query operations ==='
                sh '''
                    echo "========================================="
                    echo "GraphQL Query Operations Test Suite"
                    echo "========================================="

                    PASSED_TESTS=0
                    FAILED_TESTS=0

                    # Test 1: Query all incidents
                    echo ""
                    echo "[1/3] Testing Query: incidents (list all)..."
                    QUERY='{
                        incidents {
                            id
                            title
                            status
                            priority
                        }
                    }'
                    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST ${GRAPHQL_ENDPOINT} \
                        -H "Content-Type: application/json" \
                        -d "{\"query\": \"$(echo $QUERY | tr '\n' ' ')\"}")
                    HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
                    BODY=$(echo "$RESPONSE" | head -n -1)

                    if [ "$HTTP_CODE" == "200" ] && echo "$BODY" | jq . > /dev/null 2>&1; then
                        echo "✓ Query incidents: SUCCESS (HTTP 200)"
                        PASSED_TESTS=$((PASSED_TESTS + 1))
                    else
                        echo "✗ Query incidents: FAILED (HTTP $HTTP_CODE)"
                        echo "Response: $BODY"
                        FAILED_TESTS=$((FAILED_TESTS + 1))
                    fi

                    # Test 2: Query incident by status
                    echo ""
                    echo "[2/3] Testing Query: incidentsByStatus..."
                    QUERY='{
                        incidentsByStatus(status: OPEN) {
                            id
                            title
                            status
                        }
                    }'
                    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST ${GRAPHQL_ENDPOINT} \
                        -H "Content-Type: application/json" \
                        -d "{\"query\": \"$(echo $QUERY | tr '\n' ' ')\"}")
                    HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
                    BODY=$(echo "$RESPONSE" | head -n -1)

                    if [ "$HTTP_CODE" == "200" ] && echo "$BODY" | jq . > /dev/null 2>&1; then
                        echo "✓ Query incidentsByStatus: SUCCESS (HTTP 200)"
                        PASSED_TESTS=$((PASSED_TESTS + 1))
                    else
                        echo "✗ Query incidentsByStatus: FAILED (HTTP $HTTP_CODE)"
                        echo "Response: $BODY"
                        FAILED_TESTS=$((FAILED_TESTS + 1))
                    fi

                    # Test 3: Query incident by priority
                    echo ""
                    echo "[3/3] Testing Query: incidentsByPriority..."
                    QUERY='{
                        incidentsByPriority(priority: HIGH) {
                            id
                            title
                            priority
                        }
                    }'
                    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST ${GRAPHQL_ENDPOINT} \
                        -H "Content-Type: application/json" \
                        -d "{\"query\": \"$(echo $QUERY | tr '\n' ' ')\"}")
                    HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
                    BODY=$(echo "$RESPONSE" | head -n -1)

                    if [ "$HTTP_CODE" == "200" ] && echo "$BODY" | jq . > /dev/null 2>&1; then
                        echo "✓ Query incidentsByPriority: SUCCESS (HTTP 200)"
                        PASSED_TESTS=$((PASSED_TESTS + 1))
                    else
                        echo "✗ Query incidentsByPriority: FAILED (HTTP $HTTP_CODE)"
                        echo "Response: $BODY"
                        FAILED_TESTS=$((FAILED_TESTS + 1))
                    fi

                    echo ""
                    echo "========================================="
                    echo "Query Operations Summary"
                    echo "========================================="
                    echo "Passed: $PASSED_TESTS/3"
                    echo "Failed: $FAILED_TESTS/3"
                    echo "========================================="

                    if [ $FAILED_TESTS -gt 0 ]; then
                        exit 1
                    fi
                '''
            }
        }

        stage('Test GraphQL Mutations') {
            steps {
                echo '=== Testing GraphQL Mutation operations ==='
                sh '''
                    echo "========================================="
                    echo "GraphQL Mutation Operations Test Suite"
                    echo "========================================="

                    PASSED_TESTS=0
                    FAILED_TESTS=0

                    # Test 1: Create incident mutation
                    echo ""
                    echo "[1/4] Testing Mutation: createIncident..."
                    MUTATION='mutation {
                        createIncident(input: {
                            title: "GraphQL Test Incident"
                            description: "Testing GraphQL mutation"
                            priority: HIGH
                            assignee: "graphql-tester"
                        }) {
                            id
                            title
                            status
                        }
                    }'
                    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST ${GRAPHQL_ENDPOINT} \
                        -H "Content-Type: application/json" \
                        -d "{\"query\": \"$(echo $MUTATION | tr '\n' ' ')\"}")
                    HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
                    BODY=$(echo "$RESPONSE" | head -n -1)

                    if [ "$HTTP_CODE" == "200" ] && echo "$BODY" | jq . > /dev/null 2>&1; then
                        echo "✓ Mutation createIncident: SUCCESS (HTTP 200)"
                        PASSED_TESTS=$((PASSED_TESTS + 1))
                        # Extract incident ID for subsequent mutations
                        INCIDENT_ID=$(echo "$BODY" | jq -r '.data.createIncident.id // "1"' 2>/dev/null || echo "1")
                    else
                        echo "✗ Mutation createIncident: FAILED (HTTP $HTTP_CODE)"
                        echo "Response: $BODY"
                        FAILED_TESTS=$((FAILED_TESTS + 1))
                        INCIDENT_ID="1"
                    fi

                    # Test 2: Update incident mutation
                    echo ""
                    echo "[2/4] Testing Mutation: updateIncident..."
                    MUTATION="mutation {
                        updateIncident(id: \"$INCIDENT_ID\", input: {
                            title: \"Updated via GraphQL\"
                            description: \"Updated mutation test\"
                            priority: CRITICAL
                        }) {
                            id
                            title
                            priority
                        }
                    }"
                    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST ${GRAPHQL_ENDPOINT} \
                        -H "Content-Type: application/json" \
                        -d "{\"query\": \"$(echo $MUTATION | tr '\n' ' ')\"}")
                    HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
                    BODY=$(echo "$RESPONSE" | head -n -1)

                    if [ "$HTTP_CODE" == "200" ] && echo "$BODY" | jq . > /dev/null 2>&1; then
                        echo "✓ Mutation updateIncident: SUCCESS (HTTP 200)"
                        PASSED_TESTS=$((PASSED_TESTS + 1))
                    else
                        echo "✗ Mutation updateIncident: FAILED (HTTP $HTTP_CODE)"
                        echo "Response: $BODY"
                        FAILED_TESTS=$((FAILED_TESTS + 1))
                    fi

                    # Test 3: Update status mutation
                    echo ""
                    echo "[3/4] Testing Mutation: updateStatus..."
                    MUTATION="mutation {
                        updateStatus(id: \"$INCIDENT_ID\", status: IN_PROGRESS) {
                            id
                            status
                        }
                    }"
                    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST ${GRAPHQL_ENDPOINT} \
                        -H "Content-Type: application/json" \
                        -d "{\"query\": \"$(echo $MUTATION | tr '\n' ' ')\"}")
                    HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
                    BODY=$(echo "$RESPONSE" | head -n -1)

                    if [ "$HTTP_CODE" == "200" ] && echo "$BODY" | jq . > /dev/null 2>&1; then
                        echo "✓ Mutation updateStatus: SUCCESS (HTTP 200)"
                        PASSED_TESTS=$((PASSED_TESTS + 1))
                    else
                        echo "✗ Mutation updateStatus: FAILED (HTTP $HTTP_CODE)"
                        echo "Response: $BODY"
                        FAILED_TESTS=$((FAILED_TESTS + 1))
                    fi

                    # Test 4: Delete incident mutation
                    echo ""
                    echo "[4/4] Testing Mutation: deleteIncident..."
                    MUTATION="mutation {
                        deleteIncident(id: \"$INCIDENT_ID\")
                    }"
                    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST ${GRAPHQL_ENDPOINT} \
                        -H "Content-Type: application/json" \
                        -d "{\"query\": \"$(echo $MUTATION | tr '\n' ' ')\"}")
                    HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
                    BODY=$(echo "$RESPONSE" | head -n -1)

                    if [ "$HTTP_CODE" == "200" ] && echo "$BODY" | jq . > /dev/null 2>&1; then
                        echo "✓ Mutation deleteIncident: SUCCESS (HTTP 200)"
                        PASSED_TESTS=$((PASSED_TESTS + 1))
                    else
                        echo "✗ Mutation deleteIncident: FAILED (HTTP $HTTP_CODE)"
                        echo "Response: $BODY"
                        FAILED_TESTS=$((FAILED_TESTS + 1))
                    fi

                    echo ""
                    echo "========================================="
                    echo "Mutation Operations Summary"
                    echo "========================================="
                    echo "Passed: $PASSED_TESTS/4"
                    echo "Failed: $FAILED_TESTS/4"
                    echo "========================================="

                    if [ $FAILED_TESTS -gt 0 ]; then
                        exit 1
                    fi
                '''
            }
        }

        stage('Verify GraphiQL UI') {
            steps {
                echo '=== Verifying GraphiQL UI ==='
                sh '''
                    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${APP_URL}/graphiql)
                    if [ "$RESPONSE" == "200" ]; then
                        echo "✓ GraphiQL UI is accessible (HTTP 200)"
                    else
                        echo "✗ GraphiQL UI is NOT accessible (HTTP $RESPONSE)"
                        exit 1
                    fi
                '''
            }
        }
    }

    post {
        always {
            echo '=== Stopping application ==='
            sh '''
                if [ -f "app.pid" ]; then
                    kill $(cat app.pid) 2>/dev/null || true
                fi
                pkill -f 'incident-tracker' || true
            '''
            archiveArtifacts artifacts: 'logs/*.log', fingerprint: false, allowEmptyArchive: true
        }

        success {
            echo '✓ GraphQL API testing completed successfully!'
            emailext(
                subject: "✓ GRAPHQL API TESTS PASSED: ${APP_NAME} #${BUILD_NUMBER}",
                body: """
                    GRAPHQL API TEST SUITE PASSED

                    Project: ${APP_NAME}
                    Build Number: ${BUILD_NUMBER}
                    Test Status: SUCCESS

                    GraphQL Query Operations Tested:
                    ✓ incidents (list all)
                    ✓ incidentsByStatus
                    ✓ incidentsByPriority

                    GraphQL Mutation Operations Tested:
                    ✓ createIncident
                    ✓ updateIncident
                    ✓ updateStatus
                    ✓ deleteIncident

                    Build URL: ${BUILD_URL}
                    Console Output: ${BUILD_URL}console

                    ---
                    This is an automated notification from Jenkins.
                """,
                to: 'kike.ruben.coello@gmail.com',
                recipientProviders: [developers(), requestor()]
            )
        }

        failure {
            echo '✗ GraphQL API testing failed!'
            emailext(
                subject: "✗ GRAPHQL API TESTS FAILED: ${APP_NAME} #${BUILD_NUMBER}",
                body: """
                    GRAPHQL API TEST SUITE FAILED

                    Project: ${APP_NAME}
                    Build Number: ${BUILD_NUMBER}
                    Test Status: FAILURE

                    One or more GraphQL operations failed during testing.
                    Please check the console output for details.

                    Build URL: ${BUILD_URL}
                    Console Output: ${BUILD_URL}console

                    ---
                    This is an automated notification from Jenkins.
                """,
                to: 'kike.ruben.coello@gmail.com',
                recipientProviders: [developers(), requestor()]
            )
        }
    }
}
